pipeline {
  agent any

  environment {
    NPM_CONFIG_CACHE = "${WORKSPACE}/.npm"
    CI = false
  }

  tools {
    nodejs 'NodeJS 20.11.0'
  }

  stages {
    stage ('frontend build') {
      steps {
        withCredentials([file(credentialsId: 'frontend-env', variable: 'FRONTEND_ENV')]) {
          sh 'cd exec/ && chmod +x project-build-frontend.sh && ./project-build-frontend.sh'
        }
      }
    }

    stage('frontend deploy') {
      steps([$class: 'BapSshPromotionPublisherPlugin']) {
        sshPublisher(
          continueOnError: false,
          failOnError: true,
          publishers: [
            sshPublisherDesc(
              configName: 'application', 
              verbose: true,
              transfers: [
                sshTransfer(
                    execCommand: 'docker exec -i nginx bash -c "nginx -s restart"'
                )
              ]
            )
          ]
        )
      }
    }
  }
}